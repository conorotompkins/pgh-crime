---
title: "Pittsburgh Arrest Data Exploratory Analysis"
author: "Conor Tompkins"
date: "January 28, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory Analysis

The Western Pennsylvania Regional Data Center (http://www.wprdc.org/) is a great resource for data about Pittsburgh

They have published an archive of crime incident data from 2005-2015

You can download the data here: https://data.wprdc.org/dataset/uniform-crime-reporting-data

We will be using the following R packages for this analysis

- tidyverse
- lubridate
- viridis
- ggmap

Install these packages using the following code

#```{r}
#install.packages(c("tidyverse", "lubridate", "viridis", "ggmap"), repos = )
#```

Then load the packages
```{r load libraries}
library(tidyverse)
library(lubridate)
library(viridis)
library(ggmap)
```

First, we need to read the data into R

```{r read data into r}
df <- read_csv("archive-police-blotter.csv")
```
readr tells us how it interpreted the column classes, and alerted us that it was unable to load 6 rows from the data

Next, we will change the column names so they are easier to work with
```{r lower case column names}
colnames(df) <- tolower(colnames(df))
```
Then, rename the column names
```{r rename columnn names}
df <- df %>% 
  rename(date_time = incidenttime,
         location = incidentlocation,
         cleared_flag = clearedflag,
         neighborhood = incidentneighborhood,
         zone = incidentzone,
         description = hierarchydesc,
         tract = incidenttract)
```

Next, we will use lubridate to change the relevant columns to dates and times
```{r lubridate column names}
df <- df %>%
  mutate(date_time = mdy_hm(date_time),
         date = ymd(substr(date_time, 1, 10)),
         year = year(date),
         month = month(date, label = TRUE),
         wday = wday(date, label = TRUE),
         mday = mday(date))
```         
Now we will reorder the columns and select the ones we want to work with
```{r reorder column names}
df <- df %>% 
  select(date, 
         year,
         month,
         wday,
         mday,
         location,
         neighborhood,
         zone,
         description,
         cleared_flag,
         x,
         y)
```         
Let's see how the data look now
```{r glimpse data}
glimpse(df)
```


Which zone has the most arrests?
```{r zone arrest count}
df %>%
  group_by(zone) %>% 
  count() %>% 
  arrange(-n)
```

Before we start making plots, we will load my custom theme
```{r load custom theme}
source("https://raw.githubusercontent.com/conorotompkins/AdjGSAA/master/graphs/theme_nhh.R")
theme_set(theme_nhh())
```

How has the number of arrests changed over time?
```{r arrests over time}
df %>% 
  filter(zone %in% c(1:6)) %>% 
  group_by(zone, date) %>% 
  count() %>% 
  ggplot(aes(date, n, color = zone, fill = zone)) +
  #geom_point(alpha = .02) +
  geom_smooth() +
  #facet_wrap(~month, ncol = 1) +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  coord_cartesian(ylim = c(0, 60))
```

Looks like there is a data or reporting problem in Zone 6


Which neighborhood has the most arrests?
```{r neighborhood arrest count}
df %>%
  group_by(neighborhood) %>% 
  count() %>% 
  arrange(-n)
```

Which arrest descriptions are the most common?
```{r arrest descriptions}
df %>%
  #filter(incident_zone == 2) %>% 
  group_by(description) %>% 
  count() %>% 
  arrange(-n)
```
Many NA values

Have the number of marijuana-related arrests changed over time?

Create a dataframe

```{r marijuana arrests}
pot_arrests <- df %>%
  filter(grepl("MARIJUANA", description) == TRUE) %>%
  group_by(date) %>% 
  count() 

#Plot the data
ggplot(data = pot_arrests, aes(x = date, y = n)) +
  geom_smooth()
```

Let's look at how the data looks on a map

First, create the map

```{r create map}
city_map <-  get_map(location = "Oakland, Pittsburgh, PA",
               zoom = 12,
               maptype = "toner", 
               source = "stamen",
               messaging = FALSE)
```
View the map to make sure it looks right
```{r view map}
city_map
```

Filter out data that is not in one of the six police zones

```{r filter map data}
df_map <- df %>% 
  filter(zone %in% c(1:6))
```

Put the data on the map
```{r plot map}
city_map +
  stat_density_2d(data = df_map, #Using a 2d contour
                  aes(x, #longitude
                      y, #latitude
                      fill = ..level.., #Use the count of arrests as the fill
                      alpha = .5), #Use alpha so you can see the map under the data
                  geom = "polygon") + #We want the contour in a polygon
  #facet_wrap(~wday, nrow = 2) +
  scale_fill_viridis() +
  guides(alpha = FALSE,
         fill = guide_colorbar("Count of Arrests")) +
  theme(legend.position = "bottom",
        legend.direction = "horizontal")
```